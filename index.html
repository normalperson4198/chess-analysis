<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chess Analysis</title>

  <!-- Chessboard.js CSS -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css"
  />

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    #board {
      width: 400px;
      margin-bottom: 15px;
    }

    button {
      padding: 10px 16px;
      font-size: 16px;
      cursor: pointer;
      margin-bottom: 10px;
    }

    #output {
      background: #222;
      padding: 10px;
      width: 400px;
      min-height: 40px;
      font-family: monospace;
    }
  </style>
</head>
<body>

  <h1>Chess Analysis</h1>

  <div id="board"></div>

  <input type="text" id="fenInput" placeholder="Enter FEN" style="width: 400px; padding: 6px; margin-bottom: 10px;">
  
  <button onclick="loadFEN()">Load FEN</button>
  
  <button onclick="prevMove()">← Previous Move</button>
  <button onclick="nextMove()">Next Move →</button>

  <button onclick="analyze()">Analyze</button>

  <div id="output">Engine output…</div>

  <!-- Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>

  <script>
    let moveHistory = [];
let currentMoveIndex = -1;

// Load PGN for move navigation
function loadPGN(pgn) {
  game.reset();
  game.load_pgn(pgn);
  moveHistory = game.history();
  currentMoveIndex = -1;
  board.position(game.fen());
}

// Go to next move
function nextMove() {
  if (currentMoveIndex >= moveHistory.length - 1) return;
  currentMoveIndex++;
  game.move(moveHistory[currentMoveIndex]);
  board.position(game.fen());
}

// Go to previous move
function prevMove() {
  if (currentMoveIndex < 0) return;
  game.undo();
  currentMoveIndex--;
  board.position(game.fen());
}


    // --- GAME LOGIC ---
    const game = new Chess();

    const board = Chessboard("board", {
      draggable: true,
      position: "start",
      pieceTheme:
        "https://cdn.jsdelivr.net/gh/oakmac/chessboardjs@1.0.0/website/img/chesspieces/wikipedia/{piece}.png",
      onDrop: (source, target) => {
        const move = game.move({
          from: source,
          to: target,
          promotion: "q",
        });
        if (move === null) return "snapback";
      },
    });

    // --- STOCKFISH WORKER ---
    const engine = new Worker("./engine/stockfish.js");

    engine.onmessage = (e) => {
      const line = e.data;

      if (line.includes("info depth") && line.includes("score")) {
        document.getElementById("output").textContent = line;
      }

      if (line.includes("bestmove")) {
        document.getElementById("output").textContent = line;
      }
    };

    engine.postMessage("uci");
    engine.postMessage("isready");

    // --- ANALYZE FUNCTION ---
    function analyze() {
      engine.postMessage("position fen " + game.fen());
      engine.postMessage("go depth 15");
    }

    function loadFEN() {
      const fen = document.getElementById("fenInput").value.trim();
      if (!fen) return;

      const valid = game.validate_fen(fen);
  if (!valid.valid) {
    alert("Invalid FEN: " + valid.error);
    return;
  }

  game.load(fen);       // load the FEN into the game
  board.position(fen);  // update the board
  document.getElementById("output").textContent = "FEN loaded!";
}

  </script>

</body>
</html>
