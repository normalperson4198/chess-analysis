<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Custom Chess Analysis</title>

  <!-- Chessboard styles -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/www/css/chessboard.min.css" />

  <style>
    body {
      background: #0f1220;
      color: #fff;
      font-family: system-ui, sans-serif;
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .app {
      max-width: 900px;
      width: 100%;
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 20px;
    }

    #board {
      width: 100%;
    }

    .panel {
      background: #181c3a;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,.3);
    }

    textarea, button, input {
      width: 100%;
      margin-top: 8px;
      padding: 8px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
    }

    button {
      background: #6cf;
      cursor: pointer;
      font-weight: bold;
    }

    button:hover {
      background: #8df;
    }

    .eval {
      font-size: 18px;
      margin-top: 10px;
      font-weight: bold;
    }

    .bestmove {
      opacity: .85;
      margin-top: 6px;
    }

    @media (max-width: 800px) {
      .app {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="panel">
      <div id="board"></div>
    </div>

    <div class="panel">
      <h3>Analysis</h3>

      <label>FEN / PGN</label>
      <textarea id="input" rows="4" placeholder="Paste FEN or PGN here"></textarea>

      <button onclick="loadPosition()">Load Position</button>

      <label>Depth</label>
      <input type="range" min="5" max="25" value="15" id="depth" />

      <button onclick="analyze()">Analyze</button>

      <div class="eval" id="eval">Eval: —</div>
      <div class="bestmove" id="best">Best move: —</div>

      <hr />
      <small>
        Analysis powered by Stockfish (GPLv3)
      </small>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0/chess.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/www/js/chessboard.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stockfish@16.0.0/src/stockfish.js"></script>

  <script>
    const game = new Chess();
    const board = Chessboard('board', {
      draggable: true,
      position: 'start',
      onDrop: (source, target) => {
        const move = game.move({ from: source, to: target, promotion: 'q' });
        if (!move) return 'snapback';
        analyze();
      }
    });

    const engine = Stockfish();

    engine.onmessage = (event) => {
      const line = event.data;

      if (line.includes('score')) {
        const match = line.match(/score (cp|mate) (-?\d+)/);
        if (match) {
          let value = match[2];
          let evalText = match[1] === 'cp'
            ? (value / 100).toFixed(2)
            : `Mate in ${Math.abs(value)}`;
          document.getElementById('eval').textContent = `Eval: ${evalText}`;
        }
      }

      if (line.startsWith('bestmove')) {
        const move = line.split(' ')[1];
        document.getElementById('best').textContent = `Best move: ${move}`;
      }
    };

    function analyze() {
      engine.postMessage('stop');
      engine.postMessage('position fen ' + game.fen());
      engine.postMessage('go depth ' + document.getElementById('depth').value);
    }

    function loadPosition() {
      const text = document.getElementById('input').value.trim();

      if (game.load(text) || game.loadPgn(text)) {
        board.position(game.fen());
        analyze();
      } else {
        alert('Invalid FEN or PGN');
      }
    }
  </script>
</body>
</html>
